flowchart TB
    classDef source fill:#4A90D9,stroke:#2C5F8A,color:#fff,rx:8
    classDef process fill:#F5F5F5,stroke:#CCCCCC,color:#333,rx:4
    classDef db fill:#FFD966,stroke:#BFA130,color:#333,rx:4
    classDef layer1 fill:#6DB56D,stroke:#3D7A3D,color:#fff,rx:4
    classDef layer2 fill:#E8833A,stroke:#B35F1E,color:#fff,rx:4
    classDef layer3 fill:#D94F4F,stroke:#A03030,color:#fff,rx:4
    classDef layer4 fill:#7B5EA7,stroke:#5A3D82,color:#fff,rx:4
    classDef eval fill:#5BBFBF,stroke:#3A8A8A,color:#fff,rx:4
    classDef human fill:#2C3E50,stroke:#1A252F,color:#fff,rx:8

    subgraph S1["1. Data Ingestion"]
        A1[/"Naver Search API"/]:::source
        A2["Keyword Filter"]:::process
        A3[("SQLite DB")]:::db
    end
    A1 -->|"blog, news, cafe"| A2 -->|"cleaned posts"| A3

    subgraph S2["2. Layer 1: Local LLM Classification"]
        B1["PH-LLM-3B\n(Q4_K_M, llama.cpp)"]:::layer1
        B2["Sentiment\npos / neg / neu"]:::layer1
        B3["Misinformation\nmisinfo / factual"]:::layer1
        B4["CAVES 7 Types\nA B C D E F G"]:::layer1
    end
    A3 --> B1
    B1 --> B2 & B3 & B4
    B2 & B3 & B4 --> DB2

    DB2[("DB: Labeled Posts\n+ CAVES Columns")]:::db

    subgraph S3["3. Layer 2 and 3: Advanced Analytics"]
        subgraph L2["Layer 2: Co-occurrence"]
            C1["Co-occurrence Matrix"]:::layer2
            C2["Phi Coefficients"]:::layer2
            C3["Concern Clusters"]:::layer2
        end
        subgraph L3["Layer 3: Temporal Dynamics"]
            D1["Daily CAVES Trends"]:::layer3
            D2["Event Impact Analysis"]:::layer3
            D3["Leading Indicators"]:::layer3
        end
    end
    DB2 --> C1 --> C2 --> C3
    DB2 --> D1 --> D2 --> D3

    subgraph S4["4. Layer 4: Policy Intelligence"]
        E1["Analysis Summarizer\n(L1 + L2 + L3)"]:::layer4
        E2["Claude API\n(Sonnet)"]:::layer4
        E3["Weekly Briefing\nCounter-Messages\nFact-Checks"]:::layer4
    end
    C3 --> E1
    D3 --> E1
    E1 --> E2 --> E3

    subgraph S5["5. Retrospective Evaluation"]
        F1[/"KDCA Press Releases\nand SNS Responses"/]:::source
        F2["3-Axis Comparison\nTiming / Coverage / Messaging"]:::eval
        F3["Retrospective Report"]:::eval
    end
    E3 --> F2
    F1 --> F2 --> F3

    H["Policy Decision-Maker\n(Bounded Autonomy)"]:::human
    E3 -->|"recommendations"| H
    F3 -->|"validation"| H
